<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calcul équilibre de charge: Présentation générale</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Calcul équilibre de charge
   </div>
   <div id="projectbrief">Génère un histogramme des temps associé à chaque thread avec les métriques d&#39;équilibre de charge</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Présentation générale </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
Utilisation et options</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
Test de validité des algorithmes de répartition de charge</h2>
<p>Pour tester de manière unitaire un fichier .c faire la commande suivante : </p><div class="fragment"><div class="line">./unit_test &lt;fichier&gt;</div>
</div><!-- fragment --><p>Pour tester l'ensemble des fichiers de polybench faire la commande suivante : </p><div class="fragment"><div class="line">./all_unit_tests</div>
</div><!-- fragment --><p>On obtient dans le terminal les résultats de la comparaison des matrices du fichier parallélisé et celui de base.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Calcul de l'équilibre de charge</h2>
<p>Le programme exécute les fichiers parallélisés sur la machine TRAHRHE de 64 coeurs. Il faut donc dans le fichier <a class="el" href="unit__charge_8sh.html">unit_charge.sh</a> mettre son mot de passe et son identifiant de connexion et cloner ce git dans un dossier eqCharge. Il est aussi possible de mettre le mot de passe de <a href="#" onclick="location.href='mai'+'lto:'+'per'+'ni'+'as@'+'tr'+'ahr'+'he'+'.ic'+'ub'+'e.u'+'ni'+'str'+'a.'+'fr'; return false;">perni<span style="display: none;">.nosp@m.</span>as@t<span style="display: none;">.nosp@m.</span>rahrh<span style="display: none;">.nosp@m.</span>e.ic<span style="display: none;">.nosp@m.</span>ube.u<span style="display: none;">.nosp@m.</span>nist<span style="display: none;">.nosp@m.</span>ra.fr</a>. Ensuite après avoir compilé avec </p><div class="fragment"><div class="line">make clean</div>
<div class="line">make all</div>
</div><!-- fragment --><p>on peut générer les temps d'exécution des threads pour un seul fichier avec la commande suivante : </p><div class="fragment"><div class="line">./unit_charge &lt;fichier&gt;</div>
</div><!-- fragment --><p>On peut aussi générer les données pour les fichiers <a class="el" href="gemm_8c.html">gemm.c</a> <a class="el" href="gemver_8c.html">gemver.c</a> <a class="el" href="gesummv_8c.html">gesummv.c</a> <a class="el" href="syr2k_8c.html">syr2k.c</a> <a class="el" href="syrk_8c.html">syrk.c</a> <a class="el" href="trmm_8c.html">trmm.c</a> <a class="el" href="2mm_8c.html">2mm.c</a> <a class="el" href="3mm_8c.html">3mm.c</a> <a class="el" href="atax_8c.html">atax.c</a> <a class="el" href="bicg_8c.html">bicg.c</a> <a class="el" href="mvt_8c.html">mvt.c</a> <a class="el" href="correlation_8c.html">correlation.c</a> et <a class="el" href="covariance_8c.html">covariance.c</a> avec la commande suivante : </p><div class="fragment"><div class="line">./all_unit_charge</div>
</div><!-- fragment --><p>On a ainsi généré un fichier <b><a class="el" href="result_8csv.html">result.csv</a></b> sur la machine TRAHRHE. On peut le copier sur notre machine avec la commande : </p><div class="fragment"><div class="line">scp trahrhe.icube.unistra.fr:eqCharge/polybench/result.csv &lt;chemin_vers_le_dossier_polybench&gt;</div>
</div><!-- fragment --><p>Ensuite on peut traiter les données grâce au script <a class="el" href="generate__stat_8sh.html">generate_stat.sh</a>. On exécute cette commande : </p><div class="fragment"><div class="line">cat result.csv | ./generate_stat.sh</div>
</div><!-- fragment --><p>Ainsi on a généré un fichier pdf <b>stat.pdf</b> avec les histogrammes et les statistiques. Pour calculer l'équilibre de charge en dataset DOOM il faut changer la variable TESTS en TESTSDOOM dans <a class="el" href="all__unit__charges_8sh.html">all_unit_charges.sh</a> </p>
<h1><a class="anchor" id="autotoc_md4"></a>
Métriques d'équilibre de charge</h1>
<p>Avant de commencer à mettre en place l'automatisation des mesures il faut comprendre quelles sont les métriques pertinentes à utiliser. Ces métriques apparaissent souvent dans la littérature du thread load balancing. <br  />
 On se réfère à l'article <em>Quantifying the effectiveness of load balance algorithms</em> de Olga Pearce et T. Gamblin,. <br  />
 Cet article introduit plusieurs métriques :</p><ul>
<li>Percent Imbalance Metric \((\frac{x_{max}}{\overline{x}}-1)\times100\)</li>
<li>Skewness, \(g_1= \frac{\sum_{i=1}^{n} (x_i - \overline{x})^3}{n\sigma^3} \)</li>
<li>Kurtosis, \(g_2= \frac{\sum_{i=1}^{n} (x_i - \overline{x})^4}{n\sigma^4} \)</li>
<li>Ecart-type \(\sigma=\sqrt{\frac{\sum_{i=1}^{n} (x_i - \overline{x})^2}{n}}\) <br  />
 Avec \(x_i\) le temps de travail du thread \(i\), \(\overline{x}\) le temps moyen et \(x_{max}\) le temps maximum.</li>
</ul>
<p>On peut interpréter la skewness comme un coefficient d'asymétrie plus le nombre est proche de zéro plus la distribution est symétrique. Le kurtosis correspond à un coefficient d'applatissement, il caractérise la proportion des queues de la distribution (les valeurs extremums). Si le kurtosis est supérieur à zéro il y a une majorité de valeurs élevées, s'il y a une majorité de valeurs faibles le kurtosis sera inférieur à zéro. L'écart-type caractérise l'écart absolue des valeurs à la moyenne. <br  />
 Le Percent Imbalance Metric indique l'écart entre la valeur maximal et la moyenne. <br  />
 J'utiliserai plutôt le coefficient de variation \( \frac{\sigma}{\overline{x}} \) que l'écart-type qui ne prend pas en compte l'ordre de grandeur des valeurs et le coefficient de Gini qui caractérise bien l'écart entre chaque valeur \( \frac{\sum_{i=1}^{n}\sum_{j=1}^{n} |x_i - x_j|}{2n^2\overline{x}} \). </p>
<h1><a class="anchor" id="autotoc_md5"></a>
Mise en place du script d'automatisation de calcul de charges</h1>
<h2><a class="anchor" id="autotoc_md6"></a>
Repère des zones de collecte des temps</h2>
<p>On souhaite modifier le programme parallélisé pour en sortie donner les temps de travail de chaque thread. Il faut donc repérer les section parallèle dans les programmes. Reprenons cet exemple : </p><div class="fragment"><div class="line">#pragma omp for schedule(static)</div>
<div class="line">for ( i = 0 ; i &lt; N ; i++ ) {</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p>La problématique ici est que l'on ne peut faire la collecte des temps en fin de boucle \(for \) car la synchronisation sera faite. Il faut donc modifier les sections parallèles en : </p><div class="fragment"><div class="line">#pragma omp parallel</div>
<div class="line">{</div>
<div class="line">#pragma omp for schedule(static) nowait</div>
<div class="line">for ( i = 0 ; i &lt; N ; i++ ) {</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line">//COLLECTE DES TEMPS</div>
<div class="line">}</div>
</div><!-- fragment --><p>Ainsi on peut récolter les temps avant la synchronisation. Il faut aussi ajouter la clause nowait pour que les threads se s'attendent pas mutuellement. Pour la collecte des temps on utilise un tableau de double : </p><div class="fragment"><div class="line">double _time_threads[MAX_THREADS];</div>
</div><!-- fragment --><p>On défini aussi une fonction pour obtenir le temps \(rtclock() \) On a donc le code suivant : </p><div class="fragment"><div class="line">/* Premier appel a la fonction rtclock */</div>
<div class="line">t_start = rtclock();</div>
<div class="line">#pragma omp parallel</div>
<div class="line">{</div>
<div class="line">#pragma omp for schedule(static) nowait</div>
<div class="line">for ( i = 0 ; i &lt; N ; i++ ) {</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line">/*Collecte des temps de chaque thread */</div>
<div class="line">_time_threads[omp_get_thread_num()] += rtclock() - t_start;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Création du script de transformation de fichier</h2>
<p>La modification du fichier C est faite en bash en utilisant principalement la fonction \(sed \). Par exemple cette commande remplace tous les "apple" par des "mango". </p><div class="fragment"><div class="line">{{command}} | sed &#39;s/apple/mango/g&#39;</div>
</div><!-- fragment --><p>Par exemple avec ces instructions on ajoute \(shared(\_time\_threads) \) et \(firstprivate(t\_start) \) pour que le tableau des temps des threads soit partagé. Ensuite on change les instructions pragma omp pour pouvoir faire la collecte des temps avant la synchronisation. </p><div class="fragment"><div class="line"># On ajoute les clauses &quot;shared(_time_threads) firstprivate(t_start)&quot;</div>
<div class="line"># avant la ligne #pragma omp parallel for </div>
<div class="line">sed -i &#39;/#pragma omp parallel for/i\ &#39;&quot;$ompparallel&quot; &quot;$fichier_c&quot;</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">#On remplace #pragma omp parallel for ... par #pragma omp for ...</div>
<div class="line">sed -i &#39;s/#pragma omp parallel for/#pragma omp for/g&#39; &quot;$fichier_c&quot;</div>
</div><!-- fragment --><p>Pour la collecte des données on compte les accolades sous forme d'une pile à partir du \(omp for \). On dépile lorsque l'on rencontre une accolade fermante et on empile lorsque l'on a une accolade ouvrantes. Lorsque la pile est vide on ajoute la collecte des temps. </p>
<h2><a class="anchor" id="autotoc_md8"></a>
Script global</h2>
<p>On utilise les scripts précédents pour pouvoir effectuer la parallélisation sur ma machine puis exécuter les programmes sur la machine du laboratoire à 64 coeurs en \(ssh \). Les étapes du script charge_unit.sh sont les suivantes :</p><ul>
<li>On va chercher les tailles donnant les meilleurs performances grâce au script <a class="el" href="get__best_8py.html">get_best.py</a>.</li>
<li>On lance la parallélisation avec \(polycc \) en classique statique et dynamique et en algébrique.</li>
<li>On applique le script de transformation <a class="el" href="transformation_8sh.html">transformation.sh</a> aux 3 fichiers.</li>
<li>On compile les trois fichiers.</li>
<li>On copie les exécutables sur la machine du laboratoire en ssh et on les exécute.</li>
<li>On récupère les résultats en \(.csv \).</li>
</ul>
<p>On peut ainsi tester tous les fichiers du bench \(polybench \). </p>
<h1><a class="anchor" id="autotoc_md9"></a>
Exploitation des données</h1>
<p>Une fois que l'on obtient les résultats sur la machine 64 coeurs sous forme brute on les traite et on affiche les temps sous forme d'un histogramme en \(\LaTeX \). </p>
<h2><a class="anchor" id="autotoc_md10"></a>
Calcul des statistiques d'équilibre de charge</h2>
<p>En sortie de chaque fichier modifié on obtient des données sous cette forme pour 4 threads : </p><div class="fragment"><div class="line">#gemm.c</div>
<div class="line">##TILE static </div>
<div class="line">0.029415 </div>
<div class="line">0.029407 </div>
<div class="line">0.029393 </div>
<div class="line">0.029324 </div>
<div class="line">##Execution time </div>
<div class="line">0.029572</div>
<div class="line"> </div>
<div class="line">##TILE dynamic </div>
<div class="line">0.028370 </div>
<div class="line">0.010830 </div>
<div class="line">0.029127 </div>
<div class="line">0.029127 </div>
<div class="line">##Execution time </div>
<div class="line">0.029339</div>
<div class="line"> </div>
<div class="line">##ALGEBRAIC TILE </div>
<div class="line">0.009349 </div>
<div class="line">0.009355 </div>
<div class="line">0.009335 </div>
<div class="line">0.009357 </div>
<div class="line">##Execution time </div>
<div class="line">0.011961</div>
</div><!-- fragment --><p>On crée un script en bash qui calcule les données statistiques. En premier lieu on extrait les temps d'exécutions : </p><div class="fragment"><div class="line">tile_data_static=$(grep -oP -m $i </div>
<div class="line">&#39;(?&lt;=##TILE static\s)[[0-9.\s]*(\s)*]*&#39; </div>
<div class="line">&lt;&lt;&lt; &quot;$np_data_string&quot; )</div>
</div><!-- fragment --><p>On calcule ensuite les différentes métriques avec des fonctions bash utilisant la commande \(awk \), exemple avec le calcul du Percent Imbalance Metric \((\frac{x_{max}}{\overline{x}}-1)\times100 \) </p><div class="fragment"><div class="line">calculate_pim() {</div>
<div class="line">  max=$1</div>
<div class="line">  avg=$2</div>
<div class="line">  echo $data | awk -v mean=&quot;$avg&quot; -v max=&quot;$max&quot; </div>
<div class="line">  &#39;BEGIN{FS=&quot; &quot;; count=0; sum=0; sq_sum=0; cube_sum=0; quad_sum=0;}</div>
<div class="line">  {</div>
<div class="line">  </div>
<div class="line">      }</div>
<div class="line">  END{</div>
<div class="line">      print (max/mean - 1) * 100;</div>
<div class="line">  </div>
<div class="line">  }&#39;</div>
<div class="line">}</div>
</div><!-- fragment --><p>On stocke dans des variables les différentes valeurs et on les insert dans un fichier \(\LaTeX \). </p><div class="fragment"><div class="line">\begin{table}[htbp]</div>
<div class="line">  \centering</div>
<div class="line">  \caption{Statistiques pour le fichier $task_name}</div>
<div class="line">  \begin{tabular}{|c|c|c|c|}</div>
<div class="line">    \hline</div>
<div class="line">    Statistique &amp; Algebraic Tile &amp; Tile (static) &amp; Tile (dynamic) \\\ </div>
<div class="line">    \hline</div>
<div class="line">    Skewness (g1)  &amp; $g1_atile &amp; $g1_tile &amp; $g1_tile_dynamic \\\ </div>
<div class="line">    Kurtosis (g2)  &amp; $g2_atile &amp; $g2_tile &amp; $g2_tile_dynamic \\\ </div>
<div class="line">    Coefficient de variation $ \frac{\sigma}{\overline{x}} $ &amp; $std_dev_atile &amp; $std_dev_tile &amp; $std_dev_tile_dynamic\\\ </div>
<div class="line">    Percent Imbalance metric en \% &amp; $pim_atile &amp; $pim_tile &amp; $pim_tile_dynamic\\\ </div>
<div class="line">    Coefficient de Gini  &amp; $gini_atile &amp; $gini_static &amp; $gini_dynamic\\\ </div>
<div class="line">    Temps dexecution (s) &amp; $exec_time_atile &amp; $exec_time_tile &amp; $exec_time_tile_dynamic \\\ </div>
<div class="line"> </div>
<div class="line">    \hline</div>
<div class="line">  \end{tabular}</div>
<div class="line">\end{table}</div>
</div><!-- fragment --><p>Pour chaque jeu de données brutes on génère ainsi un histogramme des temps des threads et un tableau contenant les métriques d'équilibre de charge.</p>
<hr  />
 </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
